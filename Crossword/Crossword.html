<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Crossword</title>
	<style type="text/css">
		body, input {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			font-size: 9pt;
		}

		body {
			padding: 10px;
		}

		table {
			border-collapse: collapse;
			empty-cells: show;
		}

		fieldset {
			width: 200px;
		}

		fieldset > legend {
			padding: 5px;
		}

			fieldset td input[type=number] {
				width: 35px;
			}

		.hidden {
			display: none;
		}

		.unhidden {
			display: block;
		}

		.grid table {
			/*display: inline-block;*/
			border: 0;
			border-spacing: 0;
		}

			.grid td {
				height: 32px;
				width: 32px;
				border: 1px solid black;
			}

			.grid td {
				background-repeat: no-repeat;
				text-align: center;
				vertical-align: middle;
			}

			.grid input[type=text] {
				height: 32px;
				width: 32px;
				border: 0;
				padding: 0;
				margin: 0;
				color: black;
				background-color: transparent;
				font-size: 18px;
				font-weight: 600;
				text-transform: uppercase;
				text-align: center;
				vertical-align: middle;
			}

			.grid input[type=checkbox] {
				height: 30px;
				width: 30px;
				border: 0;
				padding: 0;
				margin: 0;
				font-size: 8px;
				text-align: center;
				vertical-align: middle;
				cursor: pointer;
				-webkit-appearance: none;
				appearance: none;
			}

			.grid td:has(input[type=checkbox]):hover {
				background-color: gray;
			}

		.buttons {
			padding-top: 10px;
			text-align: center;
		}

		.button {
			border: 1px solid;
			border-color: royalblue;
			background-color: dodgerblue;
			border-radius: 2px;
			box-shadow: 3px 3px 0 rgba(1, 1, 1, 0.11);
			color: #ffffffe0;
			font-weight: 600;
			height: 25px;
			min-width: 80px;
			text-align: center;
			margin: 4px;
			cursor: pointer;
		}

			.button:hover {
				color: white;
			}

			.button:focus {
				color: white;
				border-color: dodgerblue;
				background-color: royalblue;
				box-shadow: none;
				-webkit-transform: translate(2px, 2px);
				transform: translate(2px, 2px)
			}

		.white {
			background-color: white;
		}

		.black {
			background-color: black;
		}

		.yellow {
			background-color: yellow;
		}

		.error {
			color: Crimson;
			font-weight: 600;
			font-size: 10pt;
		}

		.across-start {
			border: 1px solid blue !important;
		}
	</style>

	<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
	<script type="text/javascript">
		// Constants
		const SvgNumber = 'url("data:image/svg+xml,<%3Fxml%20version=\\"1.0\\"%20encoding=\\"utf-8\\"%3F><!DOCTYPE%20svg%20PUBLIC%20\\"-//W3C//DTD%20SVG%201.1//EN\\"%20\\"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\\"><svg%20version=\\"1.1\\"%20xmlns=\\"http://www.w3.org/2000/svg\\"%20xmlns:xlink=\\"http://www.w3.org/1999/xlink\\"%20xmlns:xml=\\"http://www.w3.org/XML/1998/namespace\\"%20width=\\"30\\"%20height=\\"30\\"><g><text%20x=\\"1px\\"%20y=\\"7px\\"%20font-family=\\"Arial\\"%20font-size=\\"8px\\"%20font=\\"Arial\\"%20style=\\"fill:gray;\\">{0}</text></g></svg>")';
		const MaxGridArea = 2500;
		const MinRows = 5;
		const MinColumns = 5;
		const MaxRows = 25;
		const MaxColumns = 25;

		// Variables
		var currentRow, currentColumn, currentDirection;
		
		// Events
		$(document).ready(function () {
			// Set cell bg black if checked
			/*$(".grid").find("input[type='checkbox']").click(function () {
				$(this).parent().css("background-color", this.checked ? "#000" : "#fff");
				setBackgrounds();
			});*/

			nextStep();
		});


		// Common functions
		function buildId(prefix, row, column) {
			return prefix.concat("_", row, "_", column);
		}

		function rowCount() {
			return parseInt($("#txtRows").val());
		}

		function columnCount() {
			return parseInt($("#txtColumns").val());
		}

		function getRow(id) {
			try {
				return parseInt(id.split("_")[1]);
			} catch (e) {
				console.warn("Exception raised in getRow()\n" + e);
				return NaN;
			}
		}

		function getColumn(id) {
			try {
				return parseInt(id.split("_")[2]);
			} catch (e) {
				console.warn("Exception raised in getColumn()\n" + e);
				return NaN;
			}
		}

		function setCurrentPos(row, col) {
			try {
				currentRow = row;
				currentColumn = col;
				//console.log("currentRow:" + row + ", currentColumn" + col);
				return true;
			}
			catch (e) {
				console.warn("Exception raised in setCurrentPos()\n" + e);
				return false;
			}
		}

		function toggleDirection(row, col) {
			if (row == currentRow && col == currentColumn)
				currentDirection = currentDirection == "horizontal" ? "vertical" : "horizontal";
			setCurrentPos(row, col);

			$("td[tabindex]").prop("tabindex", -1);
			//$("td[tabindex]").removeAttr("tabindex");

			if (currentDirection == "horizontal") {
				var acrossStart = $("[class~=across-start]");
				for (var i = 0; i < acrossStart.length; i++) {
					$("#" + acrossStart[i].id).attr("tabindex", i);
				}
			}
			//var i = 0;
			//if (currentDirection == "horizontal") {
			//	for (var r = 0; r < rowCount; r++) {
			//		for (var c = 0; c < columnCount; c++) {
			//			var cell1 = buildId("#Cell", r, c);
			//			var cell2 = buildId("#Cell", r, c + 1);
			//			if ($(cell1).css("background-color") != "none") {
							
			//				$(cell).prop("tabindex", i);
			//				i++;
			//			} else {
			//				$(cell).prop("tabindex", -1);
			//			}
			//		}
			//	}
			//}
		}

		function isChecked(chk) {
			return chk.prop("id") != undefined && chk.prop("checked");
		}

		// Validation
		function validateInput() {
			var rows = rowCount();
			var cols = columnCount();

			if (rows < MinRows || cols > MaxRows) {
				displayError("Invalid number of <b>Rows</b>.");
				return false;
			} else if (cols < MinColumns || cols > MaxColumns) {
				displayError("Invalid number of <b>Columns</b>.");
				return false;
			} else if (rows * cols > MaxGridArea) {
				displayError("Grid area cannot exceed " + MaxGridArea + ".");
				return false;
			}
			return true;
		}

		function displayError(msg) {
			$("#divError").removeClass("hidden");
			$("#spnError").html(msg);
		}


		// Page logic
		function nextStep(step) {
			if (!validateInput()) {
				return false;
			}
			$("#divError").addClass("hidden");
			
			switch (step) {
				case 1:
					currentRow = -1;
					currentColumn = -1;
					currentDirection = "horizontal";
					$("#divStep1").removeClass("hidden");
					$("#divStep2").addClass("hidden");
					$("#divStep3").addClass("hidden");
					$("#divGrid").addClass("hidden");
					$("[class*=black]").removeClass("black");
					//$("[class*=white]").removeClass("white")
					break;
				case 2:
					$("#divStep1").addClass("hidden");
					$("#divStep2").removeClass("hidden");
					$("#divStep1").addClass("hidden");
					$("#divGrid").removeClass("hidden");
					buildTable(step);
					break;
				case 3:
					$("#divStep1").addClass("hidden");
					$("#divStep2").addClass("hidden");
					$("#divStep3").removeClass("hidden");
					$("#divGrid").removeClass("hidden");
					buildTable(step);
					break;
				default:
					nextStep(1);
					break;
			}
		}

		function buildTable(step) {
			try {
				var rows = rowCount();
				var cols = columnCount();

				if (step == 2) $("#divGrid").html("");
				
				var tbl = $(document.createElement("table")).appendTo("#divGrid");
				tbl.prop("id", "tblGrid");
				tbl.prop("class", "grid");
				
				for (var r = 0; r < rows; r++) {
					var tr;
					var trId = "Row_" + r;
					
					if (step == 2) {
						tr = $(document.createElement("tr")).appendTo(tbl);
						tr.prop("id", trId);
					} else if (step == 3) {
						tr = $("#" + trId);
					}
					
					for (var c = 0; c < cols; c++) {
						var td, chk;
						var tdId = buildId("Cell", r, c);
						var chkId = buildId("Chk", r, c);
						
						if (step == 2) {
							td = $(document.createElement("td")).appendTo(tr);
							td.prop("id", tdId);
							td.prop("class", "cell row" + r + " cell" + c);
							chk = $(document.createElement("input")).appendTo(td);
							chk.prop("id", chkId);
							chk.prop("type", "checkbox");
							chk.click(function () {
								cellCheck(this);
							});
						} else if (step == 3) {
							td = $("#" + tdId);
							chk = $("#" + chkId);

							if (!chk.prop("checked")) {
								var txt = $(document.createElement("input")).appendTo(td);
								txt.prop("id", buildId("Text", r, c));
								txt.prop("type", "text");
								txt.prop("maxlength", "1");
								//txt.prop("tabindex", "-1");
								//txt.prop("pattern", "[a-zA-Z]*");
								//txt.prop("oninvalid", "setCustomValidity(char is invalid')")

								// Mouse events happen in this order: focus, click/contextmenu
								txt.focus(function () {
									//console.log("focus");
									this.select();
								});
								txt.click(function (e) {
									//console.log("click");
									highlightAnswer(this);
								});
								//txt.contextmenu(function (e) {
								//	//console.log("contextmenu");
								//	//if (e.which == 3) toggleDirection();
								//});

								//txt.bind("paste", function (e) {
								//	var s = e.originalEvent.clipboardData.getData("Text");
								//	console.log("Pasted: " + s);
								//	moveNext(e, this);
								//});

								// Keyboard events happen in this order: keydown, keypress, keyup
								txt.keydown(function (e) {
									console.log("keydown " + e.which + " (" + e.key + ")");
									//moveNext(e, this);
									//e.preventDefault();
								});
								//txt.keypress(function (e) {
								//	console.log("keypress " + e.which + " (" + e.key + ")");
								//	moveNext(e, this);
								//});
								txt.keyup(function (e) {
									console.log("keyup " + e.which + " (" + e.key + ")");
									moveNext(e, this);
									//e.preventDefault();
								});
							}
							chk.remove();
						}
					}
				}
				if (step == 2) setBackgrounds();
			} catch (e) {
				console.warn("Exception raised in buildTable()\n" + e);
			}
		}

		function cellCheck(chk) {
			if (chk.checked)
				$(chk).parent("td").addClass("black");
			else
				$(chk).parent("td").removeClass("black");

			setBackgrounds();
		}

		function highlightAnswer(txt) {
			// Clear the bg color class
			$("#tblGrid").find("td").removeClass("yellow");

			var row = getRow(txt instanceof jQuery ? txt.prop("id") : txt.id);
			var col = getColumn(txt instanceof jQuery ? txt.prop("id") : txt.id);
			var cells, start, end;

			toggleDirection(row, col);

			if (currentDirection == "horizontal") {
				start = 0;
				end = columnCount();
				cells = $("#Row_" + row).find(".black");

				// Find first blank cell before and after this
				//var acrossStart = $("[class~=across-start]");
				//for (var i = 0; i < acrossStart.length; i++) {

				//}

				for (var i = 0; i < cells.length; i++) {
					var id = getColumn(cells[i].id);
					if (id <= col) {
						start = id + 1;
					} else {
						end = id;
						break;
					}
				}
				// Now set the bg color
				for (var i = start; i < end; i++) {
					$(buildId("#Cell", row, i)).addClass("yellow");
				}
			} else {
				start = 0;
				end = rowCount();
				var cells = $("#tblGrid").find(".black.cell" + col);

				// Find first blank cell above and below
				for (var i = 0; i < cells.length; i++) {
					var id = getRow(cells[i].id);
					if (id <= row) {
						start = id + 1;
					} else {
						end = id;
						break;
					}
				}
				// Now set the bg color
				for (var i = start; i < end; i++) {
					$(buildId("#Cell", i, col)).addClass("yellow");
				}
			}

			txt.select();
			txt.focus();
		}

		function moveNext(e, txt) {
			var row = getRow(txt.id);
			var col = getColumn(txt.id);
			if (!setCurrentPos(row, col)) return false;

			//console.log(e.which + " (" + e.key + ") pressed");

			switch (e.which) {
				case 8:  // "Backspace"
					txt.value = "";
					if (currentDirection == "horizontal")
						moveHorizontal(e, txt, "left");
					else
						moveVertical(e, txt, "up");
					break;
				case 9:  // "Tab"
					e.preventDefault();
					moveNextAnswer(txt);
					break;
				//case 32:  // " "
				//	txt.value = "";
				//	e.preventDefault();
				//	break;
				case 37:  // "ArrowLeft"
					if (currentDirection == "vertical")
						highlightAnswer(txt);
					moveHorizontal(e, txt, "left");
					break;
				case 38:  // "ArrowUp"
					if (currentDirection == "horizontal")
						highlightAnswer(txt);
					else
						moveVertical(e, txt, "up");
					break;
				case 39:  // "ArrowRight"
					if (currentDirection == "vertical")
						highlightAnswer(txt);
					else
						moveHorizontal(e, txt, "right");
					break;
				case 40:  // "ArrowDown"
					if (currentDirection == "horizontal")
						highlightAnswer(txt);
					else
						moveVertical(e, txt, "down");
					break;
				case 91:  // "Meta" (Win)
					e.preventDefault();
					break;
				default:
					if (e.which >= 65 && e.which <= 122) { // a-Z
						if (currentDirection == "horizontal")
							moveHorizontal(e, txt, "right");
						else
							moveVertical(e, txt, "down");
					} else {
						console.error("Invalid character");
						txt.value = "";
						e.preventDefault();
					}
					break;
			}
			setCurrentPos(row, col);
		}

		function moveNextAnswer(txt) {
			var row = getRow(txt.id);
			var col = getColumn(txt.id);

			if (currentDirection == "horizontal") {
				for (var r = row; r < rowCount(); r++) {
					//console.log("r=" + r)
					for (var c = col; c < columnCount() - 1; c++) {
						//console.log("c=" + c)
						var id1 = buildId("#Cell", r, c);
						var cell1 = $(id1);
						if (!cell1.length) break;
						if (r > row && c == 0 && !cell1.hasClass("black")) {
							// First cell of next row is not blank
							highlightAnswer($(id1.replace("Cell", "Text")));
							return;
						}

						var id2 = buildId("#Cell", r, c + 1)
						var cell2 = $(id2);
						if (!cell2.length) break;

						if (cell1.hasClass("black") && !cell2.hasClass("black")) {
							var txt2 = $(id2.replace("Cell", "Text"));
							//nextTxt.click(e);
							highlightAnswer(txt2);
							return;
						}
					}
					c = 0;
				}
			} else {

			}
		}

		var lastTargetId = "";

		function moveHorizontal(e, txt, dir) {
			console.log("lastTargetId=" + lastTargetId + "currentTargetId=" + e.currentTarget.id)
			console.warn("moveHorizontal called from " + e.type);

			if (e.currentTarget.id != lastTargetId) {
				var row = getRow(txt.id);
				var col = getColumn(txt.id);
				//console.warn("row=" + row + "col=" + col)
				if (row != NaN && col != NaN) {
					var nextCol = dir == "left" ? col - 1 : col + 1;
					var elem = $(buildId("#Text", row, nextCol));
					if (elem.length) {
						elem.select();
						elem.focus();
					}
				}
			} else {
				e.preventDefault();
			}

			lastTargetId = e.currentTarget.id;
		}

		function moveVertical(e, txt, dir) {
			console.log("lastTargetId=" + lastTargetId + "currentTargetId=" + e.currentTarget.id)
			console.warn("moveVertical called from " + e.type);

			if (e.currentTarget.id != lastTargetId) {
				var row = getRow(txt.id);
				var col = getColumn(txt.id);
				//console.warn("row=" + row + "col=" + col)
				if (row != NaN && col != NaN) {
					var nextRow = dir == "up" ? row - 1 : row + 1;
					var elem = $(buildId("#Text", nextRow, col));
					if (elem.length) {
						elem.select();
						elem.focus();
					}
				}
			} else {
				e.preventDefault();
			}
			
			lastTargetId = e.currentTarget.id;
		}
		
		function setBackgrounds() {
			try {
				var number = 0;
				var cells = $(".grid").find(".cell");

				for (var i = 0; i < cells.length; i++) {
					var id = cells[i].id;
					var arr = new String(id).replace("Cell_", "").split("_");
					var row = parseInt(arr[0]);
					var cell = parseInt(arr[1]);

					var thisCell = $("#" + id);							// This table cell
					var thisChk = $(buildId("#Chk", row, cell));		// The checkbox inside
					var leftChk = $(buildId("#Chk", row, cell - 1));	// Checkbox to the left of this
					var rightChk = $(buildId("#Chk", row, cell + 1));	// Checkbox to the right of this
					var prevRowChk = $(buildId("#Chk", row - 1, cell));	// Checkbox above this row
					var nextRowChk = $(buildId("#Chk", row + 1, cell));	// Checkbox below this row

					if (isChecked(thisChk)) {
						thisCell.css("background-image", "none");
					}
					else if (row == 0 || cell == 0 ||
						(isChecked(leftChk) && !isChecked(rightChk)) ||
						(isChecked(prevRowChk) && !isChecked(nextRowChk))) {
						number++;
						// Add background SVG as inline style
						var img = SvgNumber.replace("{0}", number);
						thisCell.css("background-image", img);

						if (isChecked(leftChk) && !isChecked(rightChk) && !isChecked(nextRowChk))
							thisCell.addClass("across-start");

						//thisCell.prop("tabindex", number);
					} else {
						thisCell.css("background-image", "none");
					}
				}
			} catch (e) {
				console.warn("Exception raised in setBackgrounds()\n" + e);
			}
		}
	</script>
</head>
<body>
	<div>
		<h1>Crossword</h1>
	</div>

	<!-- Step 1 -->
	<div id="divStep1" class="hidden" style="padding-bottom: 20px;">
		<fieldset id="fsDimensions">
			<legend>Choose Dimensions</legend>
			
			<table id="tblDimensions">
				<colgroup id="cgDimensions">
					<col class="colDimensions1" style="width: 100px" />
					<col class="colDimensions2" />
				</colgroup>
				<tr>
					<td>Rows:</td>
					<td>
						<input type="number" id="txtRows" runat="server" min="5" max="25" value="15" />
					</td>
				</tr>
				<tr>
					<td>Columns:</td>
					<td>
						<input type="number" id="txtColumns" runat="server" min="5" max="25" value="15" />
					</td>
				</tr>
			</table>
			<div style="padding-top: 10px; text-align: center">
				<input type="button" id="btnReset1" onclick="nextStep(1);" class="button" value="Reset" />
				<input type="button" id="btnStep1" runat="server" class="button" onclick="nextStep(2);" value="Next >>" />
			</div>
		</fieldset>
	</div>

	<!-- Step 2 -->
	<div id="divStep2" class="hidden" style="padding-bottom: 20px;">
		<fieldset id="fsLayout">
			<legend>Set Layout</legend>
			<p>
				Click cells to insert blanks.
			</p>
			<div style="padding-top: 10px; text-align: center">
				<input type="button" id="btnReset2" onclick="nextStep(1);" class="button" value="Reset" />
				<input type="button" id="btnStep2" onclick="nextStep(3);" class="button" value="Next >>" />
			</div>
		</fieldset>
	</div>

	<!-- Grid -->
	<div id="divGrid" class="hidden"></div>

	<!-- Step 3 -->
	<div id="divStep3" class="hidden" style="padding-top: 20px;">
		<input type="button" id="btnReset3" onclick="nextStep(1);" class="button" value="Reset" />
	</div>

	<!-- Error -->
	<div id="divError" class="hidden" style="width: 100%">
		<span id="spnError" class="error"></span>
	</div>
</body>
</html>